# מערכת ייבוא נכסים מקובץ Excel למתווכים

## סקירה כללית
מאפשר למתווכים לייבא מספר רב של מודעות נכסים מקובץ Excel, בכפוף לאישור מנהל.

## תהליך העבודה

### 1. בקשת הרשאה (מתווך)
- המתווך נכנס ל**המודעות שלי** בפרופיל
- לוחץ על כפתור **"בקש הרשאה להעלאת קבצים"**
- ממלא סיבה לבקשה (למשל: "יש לי 50 נכסים חדשים להעלות")
- הבקשה נשלחת למנהל

### 2. אישור מנהל
- מנהל רואה בקשה חדשה בטאב **בקשות משתמשים**
- הבקשה מסוג: `IMPORT_PROPERTIES_PERMISSION`
- מנהל יכול:
  - ✅ לאשר - המתווך מקבל גישה להעלאת קבצים
  - ❌ לדחות - המתווך יכול לבקש שוב

### 3. העלאת קבצים (מתווך מאושר)
- לאחר אישור, במקום כפתור הבקשה מופיע כפתור **"העלאת נכסים מקובץ"**
- לחיצה על הכפתור מעבירה לעמוד ייבוא מיוחד למתווכים: `/broker/import-properties`

### 4. תהליך הייבוא
א. **בחירת קטגוריה**
   - בוחרים קטגוריית נכס (דירות למכירה, דירות להשכרה, וכו')
   - בוחרים סוג מודעה: רגיל (מוכר/משכיר) או דרושים (קונה/שוכר)

ב. **הורדת תבנית**
   - לוחצים על "הורד תבנית XLSX"
   - התבנית מכילה:
     - עמודות מתאימות לקטגוריה ולסוג המודעה
     - דוגמה עם נתונים לדוגמה
     - הסבר על שדות חובה

ג. **מילוי הקובץ**
   - ממלאים את הנתונים בקובץ Excel
   - כל שורה = מודעה אחת
   - חובה למלא: שם, טלפון (ושדות נוספים לפי הקטגוריה)

ד. **העלאה ותצוגה מקדימה**
   - מעלים את הקובץ המלא
   - המערכת מציגה סיכום:
     - סה"כ שורות
     - שורות תקינות (ירוק)
     - שורות בעייתיות (אדום)
     - כפילויות (צהוב)
   - טבלה עם 50 השורות הראשונות
   - רשימת שגיאות לכל שורה

ה. **אישור סופי**
   - לוחצים על "אשר ייבוא (X מודעות)"
   - **כל המודעות נוצרות בסטטוס "ממתין לאישור"** (לא מפורסמות אוטומטית!)
   - מנהל יצטרך לאשר כל מודעה בנפרד

## קבצים שהשתנו

### Client (צד לקוח)
1. **`client/src/components/broker/MyAdsTab.tsx`**
   - הוספת כפתורים:
     - בקש הרשאה (אם אין)
     - ממתין לאישור (אם יש בקשה תלויה)
     - העלאת נכסים מקובץ (אם מאושר)
   - בדיקת הרשאות מול API

2. **`client/src/pages/broker/ImportPropertiesFromFile.tsx`** (חדש)
   - עמוד ייבוא למתווכים
   - זהה לעמוד האדמין אבל:
     - קורא ל-API של מתווכים (`/broker/import/*`)
     - ללא בחירת סטטוס ראשוני (תמיד PENDING)

3. **`client/src/App.tsx`**
   - הוספת route: `/broker/import-properties`

### Server (צד שרת)
1. **`server/prisma/schema.prisma`**
   - הוספת `IMPORT_PROPERTIES_PERMISSION` ל-enum `PendingApprovalType`

2. **`server/src/modules/broker/broker.routes.ts`**
   - הוספת 3 routes:
     - `POST /api/broker/import/request-permission` - בקשת הרשאה
     - `POST /api/broker/import/properties-file/preview` - תצוגה מקדימה
     - `POST /api/broker/import/properties-file/commit` - ביצוע הייבוא

3. **`server/src/modules/broker/broker.controller.ts`**
   - הוספת 3 handlers:
     - `requestImportPermission`
     - `importPropertiesPreview`
     - `importPropertiesCommit`

4. **`server/src/modules/broker/broker.service.ts`**
   - הוספת 4 שיטות:
     - `requestImportPermission()` - יצירת בקשה
     - `checkImportPermission()` - בדיקה אם יש הרשאה
     - `importPropertiesPreview()` - קריאת קובץ ואימות
     - `importPropertiesCommit()` - יצירת המודעות

5. **`server/src/modules/admin/pending-approvals.service.ts`**
   - הוספת case ב-switch לטיפול ב-`IMPORT_PROPERTIES_PERMISSION`

## API Endpoints

### בקשת הרשאה
```typescript
POST /api/broker/import/request-permission
Headers: Authorization: Bearer <token>
Body: { reason: "סיבה לבקשה" }
Response: { message: "...", data: {...} }
```

### תצוגה מקדימה
```typescript
POST /api/broker/import/properties-file/preview
Headers: 
  Authorization: Bearer <token>
  Content-Type: multipart/form-data
Body (FormData):
  file: <Excel file>
  categoryId: "uuid"
  adType: "REGULAR" | "WANTED"
Response: {
  fileName: "file.xlsx",
  totalRows: 100,
  validRows: 95,
  invalidRows: 5,
  duplicates: 0,
  warnings: [],
  preview: [...]
}
```

### ביצוע ייבוא
```typescript
POST /api/broker/import/properties-file/commit
Headers: Authorization: Bearer <token>
Body: {
  categoryId: "uuid",
  adType: "REGULAR" | "WANTED",
  data: [...] // רק שורות תקינות
}
Response: {
  success: true,
  totalRows: 95,
  successRows: 92,
  failedRows: 3,
  errors: [...]
}
```

## אבטחה ובקרה

### הרשאות
- רק מתווכים יכולים לגשת לנתיבים אלו
- חובה להיות מחובר (JWT token)
- חובה לקבל אישור מנהל לפני ייבוא

### בדיקות
1. **בבקשה**:
   - בודק אם כבר יש בקשה תלויה או מאושרת
   - מונע כפילויות בקשות

2. **בתצוגה מקדימה**:
   - בודק הרשאה
   - מאמת קובץ XLSX
   - בודק שדות חובה
   - מזהה כפילויות

3. **בייבוא**:
   - בודק הרשאה שוב
   - יוצר מודעות רק בסטטוס PENDING
   - רושם audit log

### Audit Log
כל פעולה נרשמת:
- `IMPORT_PERMISSION_REQUEST` - בקשת הרשאה
- `IMPORT_PROPERTIES` - ביצוע ייבוא עם פרטים מלאים

## תבניות Excel

התבניות משתנות לפי:
- **קטגוריה**: דירות למכירה ≠ דירות שבת ≠ נדל"ן מסחרי
- **סוג**: רגיל (יש לי נכס) ≠ דרושים (מחפש נכס)

### דוגמה: דירות למכירה - רגיל
```
תיווך | עיר | רחוב | מספר בית | סוג הנכס | מספר חדרים | שטח במר | מצב הנכס | קומה | ...
כן    | ירושלים | הרצל | 15 | דירה | 4.5 | 100 | משופץ | 2 | ...
```

### דוגמה: דירות למכירה - דרושים
```
תיווך | רחוב / אזור מבוקש | סוג הנכס | מספר חדרים | שטח במר | קומה | מצב הנכס | ...
לא    | רחוב הרצל או סביבה | דירה | 4 | 90 | 1-3 | משופץ | ...
```

## UI/UX

### אינדיקטורים במודעות שלי
```
[📁 העלאת נכסים מקובץ]     <- מאושר
[⏳ ממתין לאישור הרשאת העלאה]  <- תלוי
[📋 בקש הרשאה להעלאת קבצים]  <- אין הרשאה
```

### צבעים
- כפתור בקשה: סגול (`bg-purple-600`)
- ממתין: צהוב (`bg-yellow-100`)
- מאושר: ירוק (`bg-green-600`)

## הערות חשובות

1. **כל המודעות נוצרות בסטטוס PENDING**
   - מונע פרסום אוטומטי של תוכן לא מאושר
   - מנהל יכול לבדוק כל מודעה בנפרד

2. **אין צורך לשכפל קוד**
   - הלוגיקה של קריאת Excel ואימות זהה לאדמין
   - ההבדל העיקרי: בדיקת הרשאות

3. **הרשאה היא חד-פעמית**
   - לאחר אישור, המתווך יכול לייבא כמה שיותר קבצים
   - ניתן לבטל הרשאה ע"י דחיית הבקשה המאושרת

4. **שימוש חוזר בתבניות**
   - פונקציית `getTemplateForCategory()` זהה לאדמין
   - ניתן לחלץ לשירות משותף בעתיד

## בדיקות מומלצות

1. נסה לבקש הרשאה פעמיים - צריך להיחסם
2. נסה לייבא ללא הרשאה - צריך להיחסם
3. העלה קובץ עם שגיאות - צריך לזהות
4. אשר הרשאה כמנהל ונסה לייבא - צריך לעבוד
5. בדוק שהמודעות נוצרו בסטטוס PENDING

## מה הלאה?

אפשרויות להרחבה:
- **היסטוריית ייבואים**: רשימת כל הייבואים שביצע המתווך
- **תבניות מותאמות**: שמירת תבניות מותאמות אישית
- **עדכון המוני**: ייבוא לעדכון מודעות קיימות
- **תזמון**: תזמון ייבואים אוטומטיים מ-API חיצוני
