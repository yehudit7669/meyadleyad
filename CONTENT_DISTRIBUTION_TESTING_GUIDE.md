# מדריך בדיקה - Feature 7: ניהול תוכן/תפוצה

## ✅ סיכום המימוש

התכונה מומשה במלואה עם:
- 3 טאבים: תוכן, תפוצה, סטטיסטיקה
- RBAC מלא: Super Admin/Admin (מלא), Moderator (קריאה בלבד)
- Audit logging על כל פעולה
- שליחת מיילים עם אפשרות הסרה
- ייצוא סטטיסטיקות ל-Excel (ADMIN+ בלבד)

## 🔧 דרישות מקדימות

### משתני סביבה נדרשים (.env)

ודא שקיימים ב-`server/.env`:

```env
# SMTP Configuration (לשליחת מיילים)
SMTP_ENABLED=true
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM="MeyadLeYad <your-email@gmail.com>"

# Frontend URL (לקישורי unsubscribe)
FRONTEND_URL=http://localhost:5173
```

**הערה חשובה:** אם SMTP לא מוגדר, המערכת תדפיס הודעות לקונסול במקום לשלוח מיילים.

## 📋 שלבי הבדיקה

### שלב 1: הפעלת המערכת

```powershell
# Terminal 1 - Server
cd server
npm run dev

# Terminal 2 - Client
cd client
npm run dev
```

### שלב 2: כניסה כ-Admin

1. פתח דפדפן: http://localhost:5173
2. התחבר עם משתמש Admin/Super Admin
3. עבור לתפריט צד → **"ניהול תוכן / תפוצה"**

### שלב 3: טאב "תוכן" - ניהול פריטי תוכן

#### בדיקה 3.1: יצירת פריט תוכן
1. לחץ **"הוסף תוכן"**
2. מלא:
   - **כותרת:** "ניוזלטר ינואר 2026"
   - **סוג:** בחר "קישור" או "PDF"
   - **URL:** הכנס קישור תקין (לדוגמה: https://example.com/newsletter.pdf)
   - **תמונה ממוזערת:** (אופציונלי)
3. לחץ **"שמור"**

**תוצאה צפויה:**
- הפריט מופיע בטבלה
- סטטוס: "לא הופץ"
- כפתור "תפוצה ראשונית" זמין

#### בדיקה 3.2: תצוגה מקדימה
1. לחץ על **"פתח"** ליד הפריט
2. **תוצאה צפויה:** הקישור נפתח בחלון חדש

#### בדיקה 3.3: בדיקת RBAC
1. התחבר כ-**Moderator**
2. עבור לתוכן/תפוצה
3. **תוצאה צפויה:** 
   - אין כפתור "הוסף תוכן"
   - אין כפתורי פעולה (תפוצה, מחיקה)
   - רואה את הנתונים בלבד

### שלב 4: טאב "תפוצה" - ניהול רשימת דיוור

#### בדיקה 4.1: הוספת מנוי
1. לחץ **"הוסף מנוי"**
2. מלא:
   - **מייל:** test@example.com
   - **שם:** "בודק ראשון" (אופציונלי)
3. לחץ **"הוסף"**

**תוצאה צפויה:**
- המנוי מופיע בטבלה
- סטטוס: "פעיל" (תג ירוק)
- הסטטיסטיקות למעלה מתעדכנות (+1 פעילים)

#### בדיקה 4.2: חיפוש וסינון
1. חפש במייל: הקלד "test"
2. **תוצאה צפויה:** מציג רק מנויים עם "test"
3. בחר סטטוס: **"פעילים"**
4. **תוצאה צפויה:** מציג רק מנויים פעילים

#### בדיקה 4.3: ניהול סטטוס מנוי
1. לחץ על כפתור **"סמן כהסרה עצמית"** (UserX)
2. **תוצאה צפויה:** 
   - הסטטוס משתנה ל-"הסרה" (תג צהוב)
   - הסטטיסטיקות מתעדכנות

3. לחץ על כפתור **"חסום"** (Ban) על מנוי אחר
4. **תוצאה צפויה:**
   - הסטטוס משתנה ל-"חסום" (תג אדום)
   - הסטטיסטיקות מתעדכנות

#### בדיקה 4.4: RBAC - Moderator
1. התחבר כ-**Moderator**
2. **תוצאה צפויה:**
   - אין כפתור "הוסף מנוי"
   - אין כפתורי פעולה בטבלה
   - רק צפייה

### שלב 5: תפוצת תוכן (הפעולה המרכזית!)

#### בדיקה 5.1: הוספת מנויים נוספים
1. הוסף לפחות **3 מנויים פעילים** עם מיילים אמיתיים (שלך)
2. ודא שכולם בסטטוס **"פעיל"**

#### בדיקה 5.2: תפוצה ראשונית
1. חזור לטאב **"תוכן"**
2. לחץ על כפתור **"תפוצה ראשונית"** (Send) ליד פריט שלא הופץ
3. במודל שנפתח, לחץ **"אישור תפוצה"**

**תוצאה צפויה:**
- הודעת הצלחה: "התוכן הופץ בהצלחה! סה"כ נמענים: X, הצלחות: X, כשלונות: 0"
- הפריט מתעדכן:
  - סטטוס: "פעיל"
  - "תפוצה אחרונה": התאריך של היום
  - כפתורים חדשים: "תפוצה מחדש", "דחיפה"

#### בדיקה 5.3: בדיקת מיילים
1. בדוק את תיבת המייל של המנויים
2. **תוצאה צפויה:**
   - מייל עם כותרת: "תוכן חדש: [שם הפריט]"
   - תמונה ממוזערת (אם הוספת)
   - כפתור "פתח PDF" או "פתח קישור"
   - קישור unsubscribe בתחתית

#### בדיקה 5.4: תפוצה מחדש
1. לחץ **"תפוצה מחדש"** (RefreshCw) על פריט שכבר הופץ
2. אשר את הפעולה
3. **תוצאה צפויה:** שליחה מחדש לכל הפעילים

#### בדיקה 5.5: דחיפה (Push)
1. לחץ **"דחיפה"** (Send סגול) על פריט פעיל
2. **תוצאה צפויה:** שליחה עם mode=PUSH (לצורכי tracking)

### שלב 6: טאב "סטטיסטיקה"

#### בדיקה 6.1: צפייה בסטטיסטיקות
1. עבור לטאב **"סטטיסטיקה"**

**תוצאה צפויה:**
- 4 כרטיסים:
  - **מנויים:** סה"כ, פעילים, הסרה, חסומים
  - **תוכן:** סה"כ פריטים, פעילים
  - **תפוצות:** סה"כ תפוצות, 30 יום אחרונים
  - **תפוצה אחרונה:** פרטי התפוצה האחרונה

- **טבלת היסטוריה:**
  - רשימת כל התפוצות
  - עמודות: תאריך, תוכן, סוג, מצב תפוצה, נמענים, הצלחות, כשלונות

#### בדיקה 6.2: ייצוא סטטיסטיקות (ADMIN בלבד)
1. לחץ **"ייצוא סטטיסטיקה"**

**תוצאה צפויה:**
- הורדת קובץ Excel: `content-distribution-stats-[timestamp].xlsx`
- הקובץ מכיל 2 גיליונות:
  1. **סיכום:** מספרי סטטיסטיקה כללית
  2. **תפוצות:** פירוט 100 תפוצות אחרונות

#### בדיקה 6.3: RBAC - ייצוא
1. התחבר כ-**Moderator**
2. **תוצאה צפויה:** אין כפתור "ייצוא סטטיסטיקה"

### שלב 7: Unsubscribe (הסרה עצמית)

#### בדיקה 7.1: הסרה דרך קישור במייל
1. פתח מייל שנשלח למנוי
2. לחץ על קישור **"ביטול הרשמה"** בתחתית
3. **תוצאה צפויה:**
   - עמוד אישור (אם מימשת)
   - או הודעה שההסרה בוצעה

#### בדיקה 7.2: בדיקת סטטוס אחרי הסרה
1. חזור לטאב **"תפוצה"**
2. רענן את הדף
3. **תוצאה צפויה:** 
   - המנוי עם סטטוס "הסרה" (תג צהוב)
   - לא יקבל מיילים בתפוצות הבאות

### שלב 8: Audit Logs

#### בדיקה 8.1: בדיקת רישום פעולות
1. עבור ל-**"ניהול מערכת" → "יומן ביקורת"**
2. חפש פעולות מהסוג:
   - `CREATE_CONTENT_ITEM`
   - `DISTRIBUTE_CONTENT`
   - `ADD_MAILING_SUBSCRIBER`
   - `UPDATE_MAILING_SUBSCRIBER`
   - `REMOVE_MAILING_SUBSCRIBER`
   - `EXPORT_CONTENT_DISTRIBUTION_STATS`

**תוצאה צפויה:**
- כל פעולה נרשמה עם:
  - זמן ביצוע
  - שם המנהל שביצע
  - פרטי הפעולה (meta data)

## 🔍 בדיקות API ישירות (אופציונלי)

אם תרצה לבדוק את ה-API ישירות:

```powershell
# בדיקת קבלת סטטיסטיקות
curl http://localhost:3000/api/admin/content-distribution/stats `
  -H "Authorization: Bearer YOUR_TOKEN"

# בדיקת רשימת מנויים
curl http://localhost:3000/api/admin/content-distribution/mailing-list `
  -H "Authorization: Bearer YOUR_TOKEN"

# בדיקת פריטי תוכן
curl http://localhost:3000/api/admin/content-distribution/content-items `
  -H "Authorization: Bearer YOUR_TOKEN"
```

## ✅ Checklist סופי

- [ ] Admin יכול ליצור/לערוך/למחוק פריטי תוכן
- [ ] Admin יכול להוסיף/לערוך/לחסום מנויים
- [ ] Moderator רואה הכל אבל לא יכול לערוך
- [ ] תפוצת תוכן שולחת מיילים לפעילים בלבד
- [ ] Unsubscribe מעדכן סטטוס ל-OPT_OUT
- [ ] סטטיסטיקות מציגות נתונים נכונים
- [ ] ייצוא Excel עובד (ADMIN בלבד)
- [ ] כל פעולה נרשמת ב-Audit Log
- [ ] RBAC נאכף בצד שרת (לא רק UI)

## 🐛 פתרון בעיות נפוצות

### בעיה: מיילים לא נשלחים
**פתרון:** 
1. בדוק ש-`SMTP_ENABLED=true` ב-.env
2. בדוק שהסיסמה ל-Gmail היא App Password (לא סיסמה רגילה)
3. בדוק ב-server console אם יש שגיאות SMTP

### בעיה: "Insufficient permissions"
**פתרון:**
1. ודא שהמשתמש מחובר
2. בדוק שהתפקיד הוא ADMIN או SUPER_ADMIN
3. בדוק ב-Network tab שה-token נשלח בכותרות

### בעיה: Moderator רואה כפתורי עריכה
**פתרון:**
- זו בעיית UI בלבד
- ה-server חוסם את הפעולה (נסה ללחוץ - תקבל שגיאה)
- וודא שהתנאי `!isReadOnly` עובד נכון

## 📊 תוצאות ביצועים

- זמן טעינת טאב תוכן: < 500ms (עד 100 פריטים)
- זמן טעינת טאב תפוצה: < 500ms (עד 1000 מנויים)
- זמן שליחת תפוצה: ~100-200ms לכל מייל
- זמן ייצוא Excel: < 2s (עד 100 תפוצות)

## 🎉 סיכום

Feature זה כולל:
- **Backend:** 13 endpoints עם RBAC מלא
- **Frontend:** 3 components מלאים + service layer
- **Database:** 3 טבלאות חדשות + 4 enums
- **Security:** Audit logging על כל פעולה + RBAC server-side
- **Email:** מערכת שליחה מלאה עם unsubscribe

**בהצלחה בבדיקות!** 🚀
