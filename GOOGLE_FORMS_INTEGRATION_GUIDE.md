# מדריך אינטגרציה - Google Forms למערכת המקום

## 📋 תיאור כללי

מדריך זה מסביר כיצד לחבר טופס Google Forms למערכת המקום, כך שכל מילוי טופס יהפוך אוטומטית למודעה ממתינה לאישור באתר.

## 🎯 מה קורה כשממלאים את הטופס?

1. ✅ משתמש ממלא את הטופס ב-Google Forms
2. ✅ Google Forms מפעיל את ה-Apps Script
3. ✅ ה-Script שולח את הנתונים לשרת של המקום
4. ✅ השרת יוצר מודעה חדשה במצב "ממתינה לאישור"
5. ✅ מנהל רואה את המודעה במערכת ויכול לאשר אותה
6. ✅ לאחר אישור - המודעה עולה לאוויר והמשתמש מקבל מייל אישור

---

## 🚀 שלב 1: הכנת הטופס ב-Google Forms

### 1.1 פתיחת הטופס
1. פתח את הטופס הזה:
   ```
   https://docs.google.com/forms/d/e/1FAIpQLSd5ZjstupkxjBc9d7j7h3hOkIHVNgfjZLlCtPbB7j0cDmbt2w/edit
   ```
   (הוסף `/edit` בסוף ה-URL כדי לערוך)

### 1.2 וידוא שמות השאלות
ודא שיש לך את השאלות הבאות בטופס (השמות חייבים להיות **מדויקים**):

**שדות חובה:**
- ✅ `כתובת אימייל` - אימייל של הפרסם
- ✅ `שם מלא` - שם של הפרסם
- ✅ `מספר טלפון` - טלפון של הפרסם
- ✅ `כותרת המודעה` - כותרת למודעה
- ✅ `תיאור הנכס` - תיאור מפורט

**שדות אופציונליים:**
- `מחיר` - מחיר הנכס
- `עיר` - עיר
- `רחוב ומספר בית` - כתובת מלאה
- `מספר חדרים` - כמה חדרים
- `שטח במ״ר` - גודל הנכס
- `קומה` - באיזו קומה
- `חניה` - כן/לא
- `מעלית` - כן/לא
- `מרפסת` - כן/לא
- `מחסן` - כן/לא
- `מצב הנכס` - חדש/משופץ/שמור/דורש שיפוץ
- `תאריך כניסה` - מיידי/גמיש/תאריך מסוים

> **חשוב:** אם השמות שלך שונים, תצטרך לערוך את ה-Apps Script בהמשך.

---

## 🔧 שלב 2: התקנת Apps Script

### 2.1 פתיחת עורך ה-Script

1. בטופס, לחץ על **שלוש הנקודות ⋮** בפינה הימנית העליונה
2. בחר **Extensions** (הרחבות)
3. בחר **Apps Script**
4. ייפתח חלון חדש עם עורך קוד

### 2.2 העתקת הקוד

1. **מחק** את כל הקוד הקיים (אם יש)
2. פתח את הקובץ `GOOGLE_FORMS_APPS_SCRIPT.js` בפרויקט
3. **העתק את כל הקוד** מהקובץ
4. **הדבק** את הקוד בעורך Apps Script
5. לחץ **Ctrl+S** (או הסמל 💾) כדי לשמור

### 2.3 התאמת הגדרות (אם נדרש)

בראש הקובץ, בדוק שהגדרות אלו נכונות:

```javascript
const SERVER_URL = 'https://amakom.co.il/api/email-operations/forms/google-forms-webhook';
const FORM_TYPE = 'publish';
const CATEGORY = 'דירות למכירה';
```

### 2.4 התאמת שמות השאלות (אם נדרש)

אם שמות השאלות בטופס שלך **שונים** מהשמות המוגדרים, ערוך את `FIELD_MAPPING`:

```javascript
const FIELD_MAPPING = {
  email: 'כתובת אימייל',      // ← שנה כאן אם השם שונה
  name: 'שם מלא',             // ← שנה כאן אם השם שונה
  phone: 'מספר טלפון',        // ← שנה כאן אם השם שונה
  // וכו'...
};
```

---

## ⏰ שלב 3: יצירת Trigger (טריגר)

הטריגר אומר ל-Google: "הפעל את הקוד הזה כל פעם שהטופס נשלח"

### 3.1 פתיחת Triggers

1. בעורך Apps Script, לחץ על **סמל השעון ⏰** בתפריט הצדדי (Triggers)
2. לחץ על **+ Add Trigger** (כפתור כחול בפינה הימנית התחתונה)

### 3.2 הגדרת Trigger

מלא את ההגדרות כך:

| שדה | ערך |
|-----|-----|
| **Choose which function to run** | `onFormSubmit` |
| **Choose which deployment should run** | `Head` |
| **Select event source** | `From form` |
| **Select event type** | `On form submit` |

### 3.3 אישור הרשאות

1. לחץ **Save**
2. Google תבקש ממך לאשר הרשאות
3. לחץ **Review permissions**
4. בחר את חשבון Google שלך
5. לחץ **Advanced** → **Go to [שם הפרויקט] (unsafe)**
6. לחץ **Allow**

✅ הטריגר נוצר בהצלחה!

---

## 🧪 שלב 4: בדיקה

### 4.1 בדיקה ראשונית (אופציונלי)

לפני שמישהו ממלא את הטופס, אפשר לבדוק עם נתוני דמה:

1. בעורך Apps Script, בחר בפונקציה `testSubmission` מהתפריט הנפתח
2. לחץ על **▶ Run**
3. בדוק ב-**Execution log** (View → Logs) שהכל עבד

### 4.2 בדיקה אמיתית

1. **מלא את הטופס** עם נתוני בדיקה אמיתיים
   - ⚠️ השתמש באימייל של משתמש **רשום במערכת** (אחרת תקבל שגיאה)
2. שלח את הטופס
3. **בדוק ב-Apps Script** שנשלח:
   - Extensions → Apps Script
   - Executions (סמל ⚡ בצד)
   - האם יש הצלחה או שגיאה?

### 4.3 בדיקה במערכת המקום

1. היכנס למערכת כמנהל
2. נווט ל**"מודעות ממתינות לאישור"**
3. האם המודעה הופיעה? ✅
4. אשר את המודעה
5. המשתמש צריך לקבל **מייל אישור פרסום**

---

## 🔍 בעיות נפוצות ופתרונות

### ❌ בעיה: "User not registered"

**פתרון:** המשתמש צריך להיות רשום במערכת המקום לפני מילוי הטופס.

פתרונות אפשריים:
1. הוסף שאלה בטופס: "האם אתה רשום במערכת?"
2. הוסף קישור להרשמה בתיאור הטופס
3. ערוך את הקוד לשלוח מייל הרשמה אוטומטי (מתקדם)

### ❌ בעיה: "Invalid category"

**פתרון:** הקטגוריה לא קיימת במערכת או השם שגוי.

בדוק את `CATEGORY` בקוד:
```javascript
const CATEGORY = 'דירות למכירה';  // ← ודא שזה בדיוק השם בבסיס הנתונים
```

רשימת קטגוריות זמינות:
- `דירות למכירה`
- `דירות להשכרה`
- `דירות לשבת`
- `שטח מסחרי`
- `טאבו משותף`

### ❌ בעיה: הטריגר לא רץ

פתרון:
1. בדוק ש-Trigger נוצר (Apps Script → Triggers)
2. בדוק שהפונקציה היא `onFormSubmit`
3. בדוק שהאירוע הוא `On form submit`

### ❌ בעיה: שגיאת 500 מהשרת

פתרון:
1. בדוק שהשרת רץ
2. בדוק את הלוגים של השרת
3. ודא שה-URL נכון: `https://amakom.co.il/api/email-operations/forms/google-forms-webhook`

---

## 📊 Logs וניפוי באגים

### איך לראות Logs ב-Apps Script?

1. Apps Script → **Executions** (סמל ⚡)
2. תראה רשימה של כל הפעילויות
3. לחץ על פעילות כדי לראות פרטים

### איך לראות Logs בשרת?

```powershell
# בטרמינל, הצג לוגים של שרת Docker
docker logs meyadleyad-server -f
```

חפש שורות כמו:
```
✅ Created ad 12345 in PENDING status
📝 Form submitted, processing...
```

---

## 🎨 התאמה אישית לטפסים נוספים

### טופס "דירה להשכרה"

שכפל את הקובץ ושנה:
```javascript
const CATEGORY = 'דירות להשכרה';
```

### טופס "דירה לשבת"

שנה:
```javascript
const CATEGORY = 'דירות לשבת';
```

### טופס "דרוש"

שנה:
```javascript
const FORM_TYPE = 'wanted';
const CATEGORY = 'דירות להשכרה';  // או כל קטגוריה אחרת
```

---

## ✅ סיכום

אחרי ביצוע כל השלבים:

✅ כל מילוי טופס ב-Google Forms → מודעה ממתינה לאישור במערכת
✅ מנהל מאשר → המודעה עולה לאוויר
✅ משתמש מקבל מייל אישור פרסום
✅ תהליך אוטומטי ללא צורך בהתערבות ידנית

---

## 🆘 תמיכה

אם יש בעיה:
1. בדוק את ה-Logs ב-Apps Script (Executions)
2. בדוק את לוגים של השרת
3. ודא שהמשתמש רשום במערכת
4. ודא ששמות השאלות בטופס תואמים ל-FIELD_MAPPING

---

**הצלחה! 🎉**
