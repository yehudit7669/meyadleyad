# מערכת ניהול מודעות מלאה - מדריך למנהל מערכת

## תיאור כללי
מערכת ניהול מודעות מקיפה לאדמין עם תמיכה בסטטוסים מרובים, מעקב אחר פעולות, שליחת מיילים אוטומטית ולוגים מפורטים.

---

## 🔹 סטטוסי מודעות

### Enum: AdStatus
```typescript
DRAFT      // טיוטה - מודעה שנשמרה אך לא נשלחה לאישור
PENDING    // ממתינה לאישור - מודעה חדשה שצריכה אישור אדמין
ACTIVE     // פעילה / באוויר - מודעה מאושרת ופעילה באתר
APPROVED   // מאושרת (שמור לתאימות לאחור)
REJECTED   // נדחתה - מודעה שנדחתה ע"י אדמין
EXPIRED    // פגה תוקף - מודעה שתוקפה פג (30 יום)
REMOVED    // הוסרה ביוזמת מפרסם
```

### שדות נוספים במודעה
- `rejectedReason` - סיבת דחייה (עד 250 תווים)
- `publishedAt` - תאריך עלייה לאוויר (נקבע בעת אישור)
- `expiresAt` - תאריך פקיעת תוקף (30 יום מהפרסום)
- `removedAt` - תאריך הסרה (אם הוסרה)

---

## 🔹 Backend API

### 1. מודעות ממתינות לאישור
**GET** `/api/admin/ads/pending`

**Query Parameters:**
- `page` - מספר עמוד (ברירת מחדל: 1)
- `limit` - כמות תוצאות (ברירת מחדל: 20)
- `dateFrom` - סינון מתאריך (ISO format)
- `dateTo` - סינון עד תאריך
- `cityId` - סינון לפי עיר (UUID)
- `cityName` - סינון לפי שם עיר (חיפוש חלקי)
- `publisher` - חיפוש לפי שם/אימייל/טלפון מפרסם

**תגובה:**
```json
{
  "status": "success",
  "data": {
    "ads": [...],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 45,
      "totalPages": 3
    }
  }
}
```

---

### 2. פרטי מודעה מלאים
**GET** `/api/admin/ads/:id`

מחזיר את כל פרטי המודעה כולל:
- פרטי הנכס (סוג, מחיר, חדרים, שטח, תאריך כניסה וכו')
- תיאור מלא
- גלריית תמונות
- פרטי מפרסם מלאים

---

### 3. אישור מודעה
**POST** `/api/admin/ads/:id/approve`

**לוגיקה:**
1. בדיקה שהמודעה במצב `PENDING`
2. עדכון ל-`ACTIVE`
3. קביעת `publishedAt` לתאריך נוכחי
4. קביעת `expiresAt` ל-30 יום קדימה
5. שליחת מייל אישור למפרסם (אם האימייל מאומת)
6. רישום בלוג פעולות אדמין

**תגובה:**
```json
{
  "status": "success",
  "data": { ... },
  "message": "המודעה אושרה בהצלחה"
}
```

---

### 4. דחיית מודעה
**POST** `/api/admin/ads/:id/reject`

**Body:**
```json
{
  "reason": "טקסט חופשי עד 250 תווים"
}
```

**Validation:**
- `reason` חובה
- אורך: 1-250 תווים
- המודעה חייבת להיות במצב `PENDING`

**לוגיקה:**
1. עדכון סטטוס ל-`REJECTED`
2. שמירת סיבת דחייה ב-`rejectedReason`
3. שליחת מייל למפרסם עם הסיבה
4. רישום בלוג

---

### 5. טבלת ניהול כל המודעות
**GET** `/api/admin/ads`

**Query Parameters:**
- `page`, `limit` - פגינציה
- `status` - סינון לפי סטטוס (DRAFT, PENDING, ACTIVE, וכו')
- `search` - חיפוש חופשי בכותרת, כתובת, שם מפרסם, טלפון, אימייל

**תגובה:**
מחזירה רשימה מלאה של מודעות עם:
- מזהה מודעה
- כותרת וכתובת
- מפרסם (שם, טלפון, אימייל)
- סטטוס נוכחי
- תאריך יצירה, פרסום, פקיעה

---

### 6. שינוי סטטוס ידני
**PATCH** `/api/admin/ads/:id/status`

**Body:**
```json
{
  "status": "ACTIVE" | "PENDING" | "REJECTED" | "EXPIRED" | "REMOVED"
}
```

**לוגיקה:**
1. וולידציה של הסטטוס
2. עדכון הסטטוס
3. רישום בלוג עם הסטטוס הישן והחדש

---

## 🔹 Audit Log - תיעוד פעולות

### מודל AdminAdLog
```prisma
model AdminAdLog {
  id         String    @id @default(cuid())
  adminId    String
  adId       String
  action     String    // APPROVE, REJECT, STATUS_CHANGE
  fromStatus AdStatus?
  toStatus   AdStatus?
  reason     String?
  createdAt  DateTime  @default(now())
}
```

**רישום אוטומטי:**
- כל פעולת אישור/דחייה
- כל שינוי סטטוס ידני
- שמירת מי עשה את הפעולה ומתי
- שמירת הסטטוס הקודם והחדש

---

## 🔹 Frontend - ממשק משתמש

### 1. מסך מודעות ממתינות
**Route:** `/admin/pending`

**תכונות:**
- ✅ טבלה עם כל המודעות הממתינות
- ✅ תצוגה מקדימה של כל מודעה
- ✅ פרטי מפרסם (שם, אימייל, טלפון)
- ✅ כפתור "אשר מודעה" - ירוק
- ✅ כפתור "דחה מודעה" - אדום + שדה סיבת דחייה (חובה, עד 250 תווים)
- ✅ תצוגת גלריית תמונות
- ✅ קישור לתצוגה מקדימה בפורמט ציבורי

**אינטראקציות:**
- לחיצה על "אשר" → מודעה עוברת ל-ACTIVE ונעלמת מהרשימה
- לחיצה על "דחה" → פתיחת שדה טקסט חובה לסיבה
- הצגת Toast עם הודעת הצלחה

---

### 2. מסך ניהול סטטוס מודעות
**Route:** `/admin/ads-management`

**תכונות:**
- ✅ טבלה של **כל** המודעות
- ✅ סינון לפי סטטוס
- ✅ חיפוש חופשי (שם, כתובת, טלפון, אימייל)
- ✅ Dropdown לשינוי סטטוס ישירות מהטבלה
- ✅ תצוגת תאריכים (יצירה, פרסום, פקיעה)
- ✅ פגינציה

**עמודות בטבלה:**
1. מזהה מודעה
2. כותרת וסוג
3. כתובת (עיר + רחוב)
4. מפרסם (שם + טלפון/אימייל)
5. **Dropdown סטטוס** - ניתן לשנות ישירות
6. תאריכים
7. קישור לצפייה במודעה

---

### 3. Dashboard אדמין
**Route:** `/admin`

**כרטיסים חדשים:**
- ✅ "מודעות ממתינות" - מוביל ל-`/admin/pending`
- ✅ "ניהול מודעות" - מוביל ל-`/admin/ads-management`

---

## 🔹 מערכת מיילים

### 1. מייל אישור מודעה
**נשלח:** בעת אישור מודעה (PENDING → ACTIVE)

**תוכן:**
- ברכה וכותרת: "המודעה שלך אושרה ופורסמה בהצלחה!"
- קישור ישיר למודעה באתר
- (עתידי: PDF מצורף של המודעה)

---

### 2. מייל דחיית מודעה
**נשלח:** בעת דחיית מודעה

**תוכן:**
- הודעה: "המודעה שלך לא אושרה לפרסום"
- **סיבה:** הסיבה שהוזנה ע"י האדמין
- הסבר שאפשר לערוך ולשלוח מחדש (אם ה-flow תומך בזה)

---

## 🔹 הגנות ו-Validations

### Backend
- ✅ כל ה-endpoints תחת `/api/admin` דורשים `authenticate` + `authorize('ADMIN')`
- ✅ וולידציה של סיבת דחייה: חובה, 1-250 תווים
- ✅ וולידציה של סטטוסים מותרים
- ✅ בדיקה שהמודעה במצב PENDING לפני אישור/דחייה

### Frontend
- ✅ Protected routes - רק אדמין יכול לגשת
- ✅ Disable כפתורים בזמן טעינה
- ✅ וולידציה של שדה סיבת דחייה (חובה, עד 250 תווים)
- ✅ הצגת Toasts להצלחה/כישלון

---

## 🔹 שינויים במודעות ציבוריות

### Query ציבורי של מודעות
**שינוי:** מודעות ציבוריות מציגות כעת רק מודעות עם סטטוס:
```typescript
status: { in: [AdStatus.APPROVED, AdStatus.ACTIVE] }
```

**משמעות:**
- מודעות במצב `PENDING` לא יופיעו באתר הציבורי
- מודעות במצב `REJECTED` לא יופיעו
- מודעות במצב `DRAFT` לא יופיעו
- רק מודעות שאושרו (`ACTIVE`/`APPROVED`) יופיעו

---

## 🔹 זרימה מלאה

### תרחיש 1: יצירת מודעה + אישור
1. ✅ משתמש יוצר מודעה → סטטוס: `PENDING`
2. ✅ אדמין רואה במסך "מודעות ממתינות"
3. ✅ אדמין לוחץ "אשר מודעה"
4. ✅ סטטוס משתנה ל-`ACTIVE`
5. ✅ `publishedAt` נקבע לתאריך נוכחי
6. ✅ `expiresAt` נקבע ל-30 יום קדימה
7. ✅ מייל נשלח למפרסם
8. ✅ רישום בלוג: `APPROVE | PENDING → ACTIVE`
9. ✅ המודעה מופיעה באתר הציבורי

---

### תרחיש 2: דחיית מודעה
1. ✅ אדמין רואה מודעה במסך "ממתינות"
2. ✅ אדמין מזין סיבת דחייה (חובה)
3. ✅ לוחץ "דחה"
4. ✅ סטטוס משתנה ל-`REJECTED`
5. ✅ `rejectedReason` נשמר
6. ✅ מייל נשלח למפרסם עם הסיבה
7. ✅ רישום בלוג: `REJECT | PENDING → REJECTED | reason: "..."`
8. ✅ המודעה לא תופיע באתר הציבורי

---

### תרחיש 3: שינוי סטטוס ידני
1. ✅ אדמין נכנס למסך "ניהול מודעות"
2. ✅ מסנן לפי סטטוס / מחפש לפי שם
3. ✅ בוחר סטטוס חדש מה-dropdown
4. ✅ אישור החלפת סטטוס
5. ✅ סטטוס משתנה
6. ✅ רישום בלוג: `STATUS_CHANGE | OLD → NEW`

---

## 🔹 קבצים שנוצרו/עודכנו

### Backend
- ✅ `server/prisma/schema.prisma` - עדכון enum, שדות חדשים, מודל AdminAdLog
- ✅ `server/src/modules/admin/admin.service.ts` - כל הלוגיקה החדשה
- ✅ `server/src/modules/admin/admin.controller.ts` - controllers חדשים
- ✅ `server/src/modules/admin/admin.routes.ts` - routes חדשים
- ✅ `server/src/modules/ads/ads.service.ts` - עדכון query ציבורי
- ✅ `server/src/modules/ads/ads.validation.ts` - עדכון validation

### Frontend
- ✅ `client/src/services/api.ts` - פונקציות API חדשות
- ✅ `client/src/pages/PendingAds.tsx` - עדכון עם שדות חדשים
- ✅ `client/src/pages/AdminAdsManagement.tsx` - **קובץ חדש** - מסך ניהול מודעות
- ✅ `client/src/pages/AdminDashboard.tsx` - הוספת קישור למסך החדש
- ✅ `client/src/App.tsx` - הוספת route חדש

---

## 🔹 שאלות נפוצות

### 1. מה קורה כשמודעה פגה תוקף?
המערכת לא מחליפה אוטומטית את הסטטוס. אפשר להוסיף Cron Job שיבדוק מדי יום מודעות עם `expiresAt < now()` ולעדכן ל-`EXPIRED`.

### 2. האם משתמש יכול לראות מודעות שנדחו?
אם יש מסך "המודעות שלי", ניתן להציג שם את כל המודעות עם הסטטוס שלהן (כולל `REJECTED`).

### 3. האם אפשר לאשר מודעה שנדחתה?
כן, אדמין יכול לשנות סטטוס מ-`REJECTED` ל-`ACTIVE` דרך מסך "ניהול מודעות".

### 4. איפה רואים את ה-Audit Log?
כרגע הלוג נשמר ב-DB אבל אין UI לצפייה. אפשר להוסיף מסך נפרד בעתיד.

---

## 🔹 המשך פיתוח (אופציונלי)

### תוספות אפשריות:
- 📊 מסך Audit Log - צפייה בכל הפעולות של האדמין
- 📧 שליחת PDF של המודעה במייל אישור
- ⏰ Cron Job לפקיעת תוקף אוטומטית
- 🔔 התראות Push למנהל מערכת על מודעות חדשות
- 📈 גרפים וסטטיסטיקות על מודעות (מאושרות/נדחות לפי זמן)

---

## ✅ סיכום
המערכת כעת מאפשרת ניהול מלא של מודעות עם:
- ✅ סטטוסים מפורטים
- ✅ אישור/דחייה עם מיילים
- ✅ ניהול ידני של סטטוס
- ✅ מעקב אחר כל פעולה (Audit Log)
- ✅ הגנות ו-validations מלאות
- ✅ UI ידידותי ונוח

**הכל מוכן לשימוש!** 🚀
