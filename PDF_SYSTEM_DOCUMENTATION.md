# מערכת PDF משופרת - תיעוד

## סקירה כללית

מערכת ה-PDF עודכנה כדי להציג תוכן מלא ומסודר בעמוד אחד, עם תמונות ולוגו מוטמעים ב-Base64.

## מבנה ה-PDF (סדר חובה מלמעלה למטה)

### 1. **Header - לוגו האתר**
- אם קיים לוגו ב-BrandingConfig → מוצג הלוגו
- אם לא → טקסט "מיעדליעד" + "הלוח השבועי של בית שמש"
- הלוגו מומר ל-Base64 (PNG, עד 200x80px)

### 2. **כותרת המודעה**
- שם הנכס/כתובת (כותרת גדולה וברורה)
- קטגוריה + כתובת/עיר
- מחיר (אם קיים) בירוק בולט

### 3. **פרטי הנכס** (טבלה מסודרת)
מוצגים רק שדות שקיימים:
- סוג נכס (דירה, בית, פנטהאוז וכו')
- מספר חדרים
- שטח (מ"ר)
- קומה
- מרפסות
- מצב הנכס (חדש, משופץ, מתוחזק, דורש שיפוץ)
- ריהוט (מרוהט, מרוהט חלקי, לא מרוהט)
- תאריך כניסה
- ארנונה חודשית
- ועד בית חודשי
- מספר בית
- דרך מתווך (כן/לא)

**תגיות מאפיינים** (features):
- מיזוג אוויר, מעלית, חניה, מחסן, מרפסת, ממ"ד, מרפסת סוכה
- נוף, חצר, יחידת דיור, יחידת הורים, בריכה, משחקי ילדים, מיטת תינוק

### 4. **תיאור**
- טקסט חופשי של המפרסם
- מוצג בתיבה מסגרת עם רקע לבן
- תומך ב-RTL ושורות מרובות

### 5. **תמונה ראשית**
- התמונה הראשונה מהמודעה (לפי order)
- מומרת ל-Base64 (JPEG, עד 800x600px, איכות 85%)
- אם אין תמונה → placeholder מסודר עם אייקון 📷
- גודל: עד 280px גובה, מותאם לרוחב העמוד

### 6. **שורת מטא-נתונים** (Meta Footer)
- **תאריך פרסום** (בפורמט עברי: "11 בינואר 2026")
- **שם מפרסם** (אם קיים, אחרת "—")
- **מספר מודעה** (אם קיים)

### 7. **קוד QR**
- QR Code המוביל לקישור חי למודעה באתר
- גודל: 90x90px
- טקסט: "סרוק לצפייה במודעה באתר"
- URL מלא מתחת (בגודל קטן)

### 8. **Footer**
- "מסמך זה הופק באמצעות מערכת מיעדליעד"
- תאריך יצירת ה-PDF

## שיפורים טכניים

### המרת תמונות ל-Base64
```typescript
private async imageToBase64(imageUrl: string): Promise<string>
```
- תומך בקבצים מקומיים (`/uploads/...`)
- תומך ב-URLs חיצוניים (axios fetch)
- שימוש ב-Sharp לשינוי גודל ל-800x600px
- המרה ל-JPEG באיכות 85%
- טיפול בשגיאות - מחזיר string ריק במקום לשבור

### המרת לוגו ל-Base64
```typescript
private async getLogoBase64(): Promise<string>
```
- טוען מ-BrandingConfig
- שימוש ב-Sharp לשינוי גודל ל-200x80px
- שומר כ-PNG (תמיכה בשקיפות)
- fallback לטקסט אם אין לוגו

### אופטימיזציה ל-Puppeteer
```typescript
await page.setContent(html, { 
  waitUntil: ['load', 'domcontentloaded'],
  timeout: 30000
});
```
- לא צריך לחכות ל-network - כל הנתונים מוטמעים ב-HTML
- זמן טעינה מהיר יותר
- אמינות גבוהה יותר

## סטיילינג

### גופן וגודל
- גופן: Segoe UI, Tahoma, Arial
- גודל בסיס: 10px
- כותרת ראשית: 16px
- מחיר: 18px
- QR וטקסטים קטנים: 7-9px

### צבעים
- כחול ראשי: `#007bff`
- ירוק למחיר: `#28a745`
- רקעים: `#f8f9fa`, `#e3f2fd`
- טקסט: `#333`, `#495057`, `#666`

### מרווחים
- Padding: 8-10px
- Margins: 8-10px
- Border-radius: 6-8px

## טיפים לשימוש

### בדיקת PDF
```bash
npx tsx test-pdf-with-images.ts
```

### הקובץ יישמר ב:
```
server/test-output/ad-[ID]-with-images.pdf
```

### גודל קובץ צפוי
- בלי תמונות: ~30-50 KB
- עם תמונה אחת: ~100-150 KB
- עם לוגו ותמונה: ~120-180 KB

## תאימות

✅ Windows, Linux, Mac
✅ Puppeteer 23.9.0+
✅ Sharp 0.34.5+
✅ Node.js 18+
✅ RTL מלא (עברית)
✅ עמוד יחיד (A4)

## שגיאות נפוצות וטיפול

### תמונה לא נמצאת
- המערכת תציג placeholder במקום לשבור
- לוג שגיאה ב-console
- ה-PDF ימשיך להיווצר

### לוגו לא קיים
- המערכת תציג טקסט "מיעדליעד"
- ללא שבירה

### שדות ריקים
- מוצגים רק שדות עם ערכים
- אין שורות ריקות בטבלה

## תחזוקה עתידית

### הוספת שדה חדש
1. הוסף ל-`fieldConfig` ב-`generateAdHTML`
2. הוסף `formatter` אם צריך המרה
3. הקוד ידאג להציג רק אם יש ערך

### שינוי עיצוב
- כל הסגנונות ב-`<style>` בתוך הפונקציה
- שימוש ב-CSS classes
- שינוי קל וברור

### הוספת תמונות נוספות
- עדכן את `imageToBase64` לקבל מערך
- הוסף section חדש ב-HTML
- זכור: כל תמונה מוסיפה ~40-60 KB
