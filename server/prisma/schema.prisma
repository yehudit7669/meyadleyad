generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Ad {
  id                    String                  @id
  title                 String
  description           String
  price                 Float?
  userId                String
  categoryId            String
  cityId                String?
  address               String?
  latitude              Float?
  longitude             Float?
  customFields          Json?
  status                AdStatus                @default(PENDING)
  rejectionReason       String?
  views                 Int                     @default(0)
  contactClicks         Int                     @default(0)
  whatsappSent          Boolean                 @default(false)
  whatsappSentAt        DateTime?
  expiresAt             DateTime?
  publishedAt           DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  adNumber              Int                     @unique @default(autoincrement())
  adType                String?
  neighborhood          String?
  rejectedReason        String?
  removedAt             DateTime?
  streetId              String?
  isWanted              Boolean                 @default(false)
  requestedLocationText String?
  Category              Category                @relation(fields: [categoryId], references: [id])
  City                  City?                   @relation(fields: [cityId], references: [id])
  Street                Street?                 @relation(fields: [streetId], references: [id])
  User                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  AdImage               AdImage[]
  AdminAdLog            AdminAdLog[]
  Appointment           Appointment[]
  AvailabilitySlot      AvailabilitySlot[]
  EmailLog              EmailLog[]
  Favorite              Favorite[]
  NewspaperAd           NewspaperAd[]
  NewspaperSheetListing NewspaperSheetListing[]
  NotificationQueue     NotificationQueue[]

  @@index([adNumber])
  @@index([categoryId])
  @@index([cityId])
  @@index([createdAt])
  @@index([status])
  @@index([streetId])
  @@index([userId])
}

model AdImage {
  id          String   @id
  adId        String
  url         String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  brandedUrl  String?
  originalUrl String?
  Ad          Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
}

model BannerAd {
  id          String   @id
  title       String
  description String?
  imageUrl    String
  link        String?
  position    String
  order       Int      @default(0)
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  clicks      Int      @default(0)
  impressions Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([isActive])
  @@index([position])
}

model Category {
  id             String           @id
  name           String
  nameHe         String
  slug           String           @unique
  description    String?
  icon           String?
  parentId       String?
  order          Int              @default(0)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  Ad             Ad[]
  Category       Category?        @relation("CategoryToCategory", fields: [parentId], references: [id])
  other_Category Category[]       @relation("CategoryToCategory")
  CategoryField  CategoryField[]
  NewspaperSheet NewspaperSheet[]

  @@index([parentId])
  @@index([slug])
}

model CategoryField {
  id         String   @id
  categoryId String
  name       String
  nameHe     String
  fieldType  String
  options    String?
  isRequired Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
}

model City {
  id             String           @id
  name           String           @unique
  nameHe         String
  slug           String           @unique
  region         String?
  latitude       Float?
  longitude      Float?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  Ad             Ad[]
  Neighborhood   Neighborhood[]
  NewspaperSheet NewspaperSheet[]
  Street         Street[]
  BrokerUsers    User[]           @relation("BrokerCity")

  @@index([name])
  @@index([slug])
}

model EmailAction {
  id        String   @id
  email     String
  action    String
  token     String   @unique
  data      Json?
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model Neighborhood {
  id        String   @id
  name      String
  cityId    String
  createdAt DateTime @default(now())
  updatedAt DateTime
  City      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  Street    Street[]

  @@unique([cityId, name])
  @@index([cityId])
  @@index([name])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Street {
  id             String        @id
  name           String
  code           String
  cityId         String
  neighborhoodId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  Ad             Ad[]
  City           City          @relation(fields: [cityId], references: [id], onDelete: Cascade)
  Neighborhood   Neighborhood? @relation(fields: [neighborhoodId], references: [id])

  @@unique([cityId, code])
  @@unique([cityId, name])
  @@index([cityId])
  @@index([name])
  @@index([neighborhoodId])
}

model User {
  id                         String                       @id @default(uuid())
  email                      String                       @unique
  password                   String?
  name                       String?
  phone                      String?
  role                       UserRole                     @default(USER)
  googleId                   String?                      @unique
  avatar                     String?
  isVerified                 Boolean                      @default(false)
  verificationToken          String?                      @unique
  resetToken                 String?
  resetTokenExpiry           DateTime?
  companyName                String?
  licenseNumber              String?
  description                String?
  website                    String?
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  isEmailVerified            Boolean                      @default(false)
  resetPasswordExpires       DateTime?
  resetPasswordToken         String?                      @unique
  verificationExpires        DateTime?
  brokerLogoApproved         Boolean                      @default(false)
  brokerCityId               String?
  brokerLicenseNumber        String?
  businessAddress            String?
  businessName               String?
  businessPhone              String?
  declarationAcceptedAt      DateTime?
  firstName                  String?
  lastName                   String?
  pendingEmail               String?
  phonePersonal              String?
  serviceProviderType        ServiceProviderType?
  termsAcceptedAt            DateTime?
  userType                   UserType?                    @default(USER)
  weeklyDigestOptIn          Boolean                      @default(true)
  phoneBusinessOffice        String?
  officeAddress              String?
  officeAddressPending       String?
  logoUrlPending             String?
  aboutBusiness              String?
  aboutBusinessPending       String?
  publishOfficeAddress       Boolean                      @default(false)
  businessHours              Json?
  weeklyDigestSubscribed     Boolean                      @default(false)
  meetingsBlockReason        String?
  meetingsBlocked            Boolean                      @default(false)
  meetingsBlockedAt          DateTime?
  meetingsBlockedByAdminId   String?
  status                     UserStatus                   @default(ACTIVE)
  officeAddressStatus        ApprovalStatus               @default(APPROVED)
  logoStatus                 ApprovalStatus               @default(APPROVED)
  aboutBusinessStatus        ApprovalStatus               @default(APPROVED)
  AccountDeletionRequest     AccountDeletionRequest[]
  Ad                         Ad[]
  AppointmentOwner           Appointment[]                @relation("AppointmentOwner")
  AppointmentRequester       Appointment[]                @relation("AppointmentRequester")
  BrandingConfig             BrandingConfig[]
  Conversations              Conversation[]
  DataExportRequest          DataExportRequest[]
  EmailLog                   EmailLog[]
  Favorite                   Favorite[]
  HighlightRequest           HighlightRequest[]
  NewspaperAdCreated         NewspaperAd[]                @relation("NewspaperAdCreator")
  NewspaperSheetCreated      NewspaperSheet[]             @relation("NewspaperSheetCreator")
  NewspaperVersionGenerated  NewspaperSheetVersion[]      @relation("NewspaperVersionGenerator")
  NotificationQueue          NotificationQueue[]
  OfficeAddressChangeRequest OfficeAddressChangeRequest[]
  PendingApprovalsReviewed   PendingApproval[]            @relation("ReviewedApprovals")
  PendingApprovalsCreated    PendingApproval[]            @relation("UserApprovals")
  RefreshToken               RefreshToken[]
  SupportNotifications       SupportNotification[]
  BrokerCity                 City?                        @relation("BrokerCity", fields: [brokerCityId], references: [id])
  UserAppointmentPolicy      UserAppointmentPolicy?
  UserAudit                  UserAudit[]
  NotificationOverride       UserNotificationOverride?
  UserPreference             UserPreference?

  @@index([email])
  @@index([googleId])
  @@index([resetPasswordToken])
  @@index([verificationToken])
  @@index([brokerCityId])
  @@index([status])
}

model WhatsAppGroup {
  id         String   @id
  categoryId String   @unique
  name       String
  groupId    String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@index([categoryId])
}

model EmailLog {
  id             String      @id @default(uuid())
  userId         String?
  adId           String?
  type           EmailType
  status         EmailStatus
  recipientEmail String
  errorMessage   String?
  createdAt      DateTime    @default(now())
  Ad             Ad?         @relation(fields: [adId], references: [id])
  User           User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([adId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model AdminAdLog {
  id         String    @id @default(cuid())
  adminId    String
  adId       String
  action     String
  fromStatus AdStatus?
  toStatus   AdStatus?
  reason     String?
  createdAt  DateTime  @default(now())
  Ad         Ad        @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([adId])
  @@index([createdAt])
}

model BrandingConfig {
  id          String   @id @default(cuid())
  logoUrl     String   @default("")
  position    String   @default("bottom-left")
  opacity     Int      @default(70)
  sizePct     Int      @default(18)
  updatedById String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [updatedById], references: [id])

  @@index([updatedById])
}

model UserPreference {
  id               String   @id @default(cuid())
  userId           String   @unique
  weeklyDigest     Boolean  @default(false)
  notifyNewMatches Boolean  @default(false)
  filters          Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationSettings {
  id        String   @id @default(cuid())
  enabled   Boolean  @default(true)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model NewspaperGlobalSettings {
  id              String   @id @default(cuid())
  currentIssue    Int      @default(1)
  lastDistributed DateTime?
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
}

model UserNotificationOverride {
  id        String                       @id @default(cuid())
  userId    String                       @unique
  mode      UserNotificationOverrideMode
  expiresAt DateTime
  reason    String?
  createdAt DateTime                     @default(now())
  updatedAt DateTime                     @updatedAt
  user      User                         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model NotificationQueue {
  id           String                  @id @default(cuid())
  userId       String
  adId         String
  status       NotificationQueueStatus @default(PENDING)
  sentAt       DateTime?
  errorMessage String?
  retryCount   Int                     @default(0)
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  ad           Ad                      @relation(fields: [adId], references: [id], onDelete: Cascade)
  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, adId])
  @@index([userId])
  @@index([adId])
  @@index([status])
  @@index([createdAt])
}

model Appointment {
  id           String               @id @default(cuid())
  adId         String
  requesterId  String
  ownerId      String
  date         DateTime
  note         String?
  status       AppointmentStatus    @default(PENDING)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  statusReason String?
  proposedDate DateTime?
  ad           Ad                   @relation(fields: [adId], references: [id], onDelete: Cascade)
  owner        User                 @relation("AppointmentOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  requester    User                 @relation("AppointmentRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  history      AppointmentHistory[]

  @@index([requesterId])
  @@index([ownerId])
  @@index([adId])
  @@index([date])
  @@index([status])
}

model AppointmentHistory {
  id            String             @id @default(cuid())
  appointmentId String
  fromStatus    AppointmentStatus?
  toStatus      AppointmentStatus
  reason        String?
  changedById   String?
  createdAt     DateTime           @default(now())
  fromDate      DateTime?
  toDate        DateTime?
  appointment   Appointment        @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([createdAt])
}

model AvailabilitySlot {
  id        String   @id @default(cuid())
  adId      String
  dayOfWeek Int
  startTime String
  endTime   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
}

model UserAppointmentPolicy {
  id          String   @id @default(cuid())
  userId      String   @unique
  isBlocked   Boolean  @default(false)
  blockReason String?
  updatedById String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String
  targetId   String?
  meta       Json?
  createdAt  DateTime @default(now())
  entityType String?
  ip         String?

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@index([targetId])
  @@index([entityType])
}

model UserAudit {
  id        String   @id @default(cuid())
  userId    String
  action    String
  meta      Json?
  createdAt DateTime @default(now())
  ip        String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  adId      String
  createdAt DateTime @default(now())
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, adId])
  @@index([userId])
  @@index([adId])
}

model PageView {
  id              String   @id @default(cuid())
  path            String
  userId          String?
  durationSeconds Int?
  sessionId       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  @@index([path])
  @@index([userId])
  @@index([createdAt])
}

model MailingListSubscriber {
  id                     String            @id @default(cuid())
  email                  String            @unique
  name                   String?
  unsubscribedAt         DateTime?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  blockedAt              DateTime?
  blockedBy              String?
  emailUpdatesCategories Json?
  emailUpdatesEnabled    Boolean           @default(true)
  status                 MailingListStatus @default(ACTIVE)
  unsubscribeToken       String?           @unique

  @@index([email])
  @@index([status])
}

model ContentItem {
  id                  String                @id @default(cuid())
  title               String
  type                ContentItemType
  url                 String
  thumbnailUrl        String?
  status              ContentItemStatus     @default(NOT_DISTRIBUTED)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  createdBy           String
  lastDistributedAt   DateTime?
  distributionCount   Int                   @default(0)
  ContentDistribution ContentDistribution[]

  @@index([type])
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
}

model ContentDistribution {
  id                 String               @id @default(cuid())
  contentItemId      String
  mode               DistributionMode
  recipientsCount    Int                  @default(0)
  successCount       Int                  @default(0)
  failedCount        Int                  @default(0)
  distributedAt      DateTime             @default(now())
  distributedBy      String
  ContentDispatchLog ContentDispatchLog[]
  contentItem        ContentItem          @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId])
  @@index([distributedAt])
  @@index([distributedBy])
}

model ContentDispatchLog {
  id                    String               @id @default(cuid())
  fileName              String
  fileUrl               String?
  recipientEmail        String
  sentAt                DateTime             @default(now())
  errorMessage          String?
  contentDistributionId String?
  status                DispatchStatus       @default(SENT)
  contentDistribution   ContentDistribution? @relation(fields: [contentDistributionId], references: [id])

  @@index([contentDistributionId])
  @@index([recipientEmail])
  @@index([sentAt])
  @@index([status])
}

model ImportLog {
  id              String   @id @default(cuid())
  adminId         String
  importType      String
  fileName        String
  totalRows       Int      @default(0)
  successRows     Int      @default(0)
  failedRows      Int      @default(0)
  errors          Json?
  createdAt       DateTime @default(now())
  importedItemIds Json?
  metadata        Json?

  @@index([adminId])
  @@index([importType])
  @@index([createdAt])
}

model BrokerOffice {
  id                      String             @id @default(cuid())
  brokerOwnerUserId       String             @unique
  businessName            String
  businessAddressApproved String
  businessAddressPending  String?
  businessPhone           String?
  website                 String?
  aboutBusinessApproved   String?
  aboutBusinessPending    String?
  publishOfficeAddress    Boolean            @default(false)
  logoUrlApproved         String?
  logoUrlPending          String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  BrokerTeamMember        BrokerTeamMember[]

  @@index([brokerOwnerUserId])
}

model BrokerTeamMember {
  id        String       @id @default(cuid())
  officeId  String
  fullName  String
  email     String
  phone     String
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  office    BrokerOffice @relation(fields: [officeId], references: [id], onDelete: Cascade)

  @@index([officeId])
  @@index([email])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  actionType  String
  entityType  String?
  entityId    String?
  metadata    Json?
  ip          String?
  createdAt   DateTime @default(now())

  @@index([actorUserId])
  @@index([actionType])
  @@index([entityType])
  @@index([createdAt])
}

model FeaturedRequest {
  id        String                @id @default(cuid())
  userId    String
  adId      String
  status    FeaturedRequestStatus @default(PENDING)
  notes     String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([userId])
  @@index([adId])
  @@index([status])
}

model DataExportRequest {
  id          String            @id @default(cuid())
  userId      String
  status      DataRequestStatus @default(PENDING)
  exportUrl   String?
  createdAt   DateTime          @default(now())
  processedAt DateTime?
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model AccountDeletionRequest {
  id          String            @id @default(cuid())
  userId      String
  status      DataRequestStatus @default(PENDING)
  reason      String?
  createdAt   DateTime          @default(now())
  processedAt DateTime?
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model OfficeAddressChangeRequest {
  id          String         @id @default(cuid())
  userId      String
  newAddress  String
  adminNotes  String?
  createdAt   DateTime       @default(now())
  processedAt DateTime?
  processedBy String?
  status      ApprovalStatus @default(PENDING)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model HighlightRequest {
  id          String         @id @default(cuid())
  userId      String
  requestType String
  reason      String?
  adminNotes  String?
  createdAt   DateTime       @default(now())
  processedAt DateTime?
  processedBy String?
  status      ApprovalStatus @default(PENDING)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model NewspaperSheet {
  id           String                  @id @default(cuid())
  categoryId   String
  cityId       String
  title        String
  headerImage  String?
  layoutConfig Json?
  version      Int                     @default(1)
  pdfPath      String?
  status       NewspaperSheetStatus    @default(DRAFT)
  createdBy    String
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  issueNumber  String?
  issueDate    String?
  category     Category                @relation(fields: [categoryId], references: [id])
  city         City                    @relation(fields: [cityId], references: [id])
  creator      User                    @relation("NewspaperSheetCreator", fields: [createdBy], references: [id])
  listings     NewspaperSheetListing[]
  versions     NewspaperSheetVersion[]

  @@unique([categoryId, cityId, status])
  @@index([categoryId])
  @@index([cityId])
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
}

model NewspaperSheetListing {
  id            String         @id @default(cuid())
  sheetId       String
  listingId     String
  positionIndex Int            @default(0)
  addedAt       DateTime       @default(now())
  listing       Ad             @relation(fields: [listingId], references: [id], onDelete: Cascade)
  sheet         NewspaperSheet @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  @@unique([sheetId, listingId])
  @@index([sheetId])
  @@index([listingId])
  @@index([positionIndex])
}

model NewspaperSheetVersion {
  id          String         @id @default(cuid())
  sheetId     String
  version     Int
  pdfPath     String
  generatedBy String
  createdAt   DateTime       @default(now())
  generator   User           @relation("NewspaperVersionGenerator", fields: [generatedBy], references: [id])
  sheet       NewspaperSheet @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  @@unique([sheetId, version])
  @@index([sheetId])
  @@index([createdAt])
}

model NewspaperAd {
  id        String   @id @default(cuid())
  adId      String
  filePath  String
  version   Int      @default(1)
  createdAt DateTime @default(now())
  createdBy String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  creator   User     @relation("NewspaperAdCreator", fields: [createdBy], references: [id])

  @@index([adId])
  @@index([createdBy])
  @@index([createdAt])
}

model EmailInboundMessage {
  id             String          @id @default(cuid())
  messageId      String
  from           String
  to             String
  subject        String
  bodyText       String?
  bodyHtml       String?
  headers        Json?
  attachments    Json?
  inReplyTo      String?
  references     String?
  receivedAt     DateTime        @default(now())
  processed      Boolean         @default(false)
  processedAt    DateTime?
  createdAt      DateTime        @default(now())
  auditLogs      EmailAuditLog[]
  emailRequests  EmailRequest[]
  pendingIntents PendingIntent[]

  @@index([messageId])
  @@index([from])
  @@index([subject])
  @@index([processed])
  @@index([receivedAt])
}

model EmailRequest {
  id                String              @id @default(cuid())
  inboundMessageId  String
  senderEmail       String
  adId              String?
  payload           Json?
  failReason        String?
  publicFailMessage String?
  retryCount        Int                 @default(0)
  processedAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  commandType       EmailCommandType
  status            EmailRequestStatus  @default(PENDING)
  inboundMessage    EmailInboundMessage @relation(fields: [inboundMessageId], references: [id], onDelete: Cascade)

  @@index([senderEmail])
  @@index([commandType])
  @@index([status])
  @@index([adId])
  @@index([createdAt])
}

model PendingIntent {
  id                 String              @id @default(cuid())
  email              String
  inboundMessageId   String
  payload            Json?
  registrationSent   Boolean             @default(false)
  registrationSentAt DateTime?
  completedAt        DateTime?
  expiresAt          DateTime
  createdAt          DateTime            @default(now())
  commandType        EmailCommandType
  status             PendingIntentStatus @default(PENDING)
  inboundMessage     EmailInboundMessage @relation(fields: [inboundMessageId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([status])
  @@index([expiresAt])
}

model EmailOperationsMailingList {
  id               String             @id @default(cuid())
  email            String             @unique
  name             String?
  source           String             @default("email")
  subscriptionDate DateTime           @default(now())
  unsubscribeToken String?            @unique
  removedAt        DateTime?
  lastCommandAt    DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  status           EmailMailingStatus @default(ACTIVE)

  @@index([email])
  @@index([status])
}

model EmailRateLimit {
  id              String    @id @default(cuid())
  email           String    @unique
  requestCount    Int       @default(0)
  errorCount      Int       @default(0)
  windowStartedAt DateTime  @default(now())
  lastRequestAt   DateTime  @default(now())
  inCooldown      Boolean   @default(false)
  cooldownUntil   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([inCooldown])
  @@index([windowStartedAt])
}

model EmailAuditLog {
  id               String               @id @default(cuid())
  email            String
  action           String
  adId             String?
  success          Boolean
  failReason       String?
  publicMessage    String?
  metadata         Json?
  ip               String?
  userAgent        String?
  inboundMessageId String?
  createdAt        DateTime             @default(now())
  commandType      EmailCommandType
  inboundMessage   EmailInboundMessage? @relation(fields: [inboundMessageId], references: [id])

  @@index([email])
  @@index([action])
  @@index([commandType])
  @@index([adId])
  @@index([createdAt])
  @@index([success])
}

model PendingApproval {
  id           String              @id @default(cuid())
  userId       String
  type         PendingApprovalType
  status       ApprovalStatus      @default(PENDING)
  requestData  Json
  oldData      Json?
  reason       String?
  adminNotes   String?
  reviewedById String?
  reviewedAt   DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  reviewer     User?               @relation("ReviewedApprovals", fields: [reviewedById], references: [id])
  user         User                @relation("UserApprovals", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Conversation {
  id                 String                @id @default(cuid())
  userId             String?
  guestEmail         String?
  status             ConversationStatus    @default(OPEN)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  lastMessageAt      DateTime              @default(now())
  lastMessagePreview String?
  adminLastReadAt    DateTime?
  userLastReadAt     DateTime?
  user               User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages           Message[]
  notifications      SupportNotification[]

  @@index([userId])
  @@index([guestEmail])
  @@index([lastMessageAt])
  @@index([status])
  @@index([createdAt])
}

model Message {
  id                  String              @id @default(cuid())
  conversationId      String
  senderType          SenderType
  senderUserId        String?
  body                String
  createdAt           DateTime            @default(now())
  deliveredToEmailAt  DateTime?
  emailDeliveryStatus EmailDeliveryStatus @default(PENDING)
  conversation        Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([emailDeliveryStatus])
}

model SupportNotification {
  id             String                  @id @default(cuid())
  userId         String
  conversationId String
  type           SupportNotificationType @default(ADMIN_REPLY)
  isRead         Boolean                 @default(false)
  createdAt      DateTime                @default(now())
  conversation   Conversation            @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([conversationId])
  @@index([isRead])
  @@index([createdAt])
}

enum AdStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  DRAFT
  ACTIVE
  REMOVED
}

enum UserRole {
  USER
  BROKER
  ADMIN
  SERVICE_PROVIDER
  SUPER_ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  PARTIAL_BLOCK
  BLOCKED
}

enum UserType {
  USER
  SERVICE_PROVIDER
}

enum ServiceProviderType {
  BROKER
  LAWYER
  APPRAISER
  DESIGNER_ARCHITECT
  MORTGAGE_ADVISOR
}

enum EmailType {
  AD_PUBLISHED_COPY
  AD_APPROVED
  AD_REJECTED
  VERIFICATION
  PASSWORD_RESET
}

enum EmailStatus {
  SUCCESS
  FAILED
}

enum AppointmentStatus {
  PENDING
  APPROVED
  REJECTED
  RESCHEDULE_REQUESTED
  CANCELED
  COMPLETED
}

enum FeaturedRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DataRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NewspaperSheetStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum MailingListStatus {
  ACTIVE
  OPT_OUT
  BLOCKED
}

enum ContentItemType {
  PDF
  LINK
}

enum ContentItemStatus {
  ACTIVE
  NOT_DISTRIBUTED
  ARCHIVED
}

enum DistributionMode {
  INITIAL
  REDISTRIBUTE
  PUSH
}

enum DispatchStatus {
  SENT
  FAILED
  PENDING
}

enum EmailCommandType {
  PUBLISH_SALE
  PUBLISH_RENT
  PUBLISH_SHABBAT
  PUBLISH_COMMERCIAL
  PUBLISH_SHARED_OWNERSHIP
  WANTED_BUY
  WANTED_RENT
  WANTED_SHABBAT
  UPDATE_AD
  REMOVE_AD
  MAILING_LIST_SUBSCRIBE
  MAILING_LIST_UNSUBSCRIBE
  REGISTRATION
  UNKNOWN
}

enum EmailRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PendingIntentStatus {
  PENDING
  EXPIRED
  COMPLETED
}

enum EmailMailingStatus {
  ACTIVE
  REMOVED
}

enum PendingApprovalType {
  OFFICE_ADDRESS_UPDATE
  ABOUT_UPDATE
  LOGO_UPLOAD
  BUSINESS_DESCRIPTION
  IMPORT_PERMISSION
  IMPORT_PROPERTIES_PERMISSION
  ACCOUNT_DELETION
  HIGHLIGHT_AD
}

enum UserNotificationOverrideMode {
  ALLOW
  BLOCK
}

enum NotificationQueueStatus {
  PENDING
  SENT
  FAILED
}

enum ConversationStatus {
  OPEN
  CLOSED
}

enum SenderType {
  USER
  ADMIN
  GUEST
}

enum EmailDeliveryStatus {
  PENDING
  SENT
  FAILED
  NOT_REQUIRED
}

enum SupportNotificationType {
  ADMIN_REPLY
  NEW_MESSAGE
}
