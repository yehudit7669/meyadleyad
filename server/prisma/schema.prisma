generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Ad {
  id                    String             @id
  title                 String
  description           String
  price                 Float?
  userId                String
  categoryId            String
  cityId                String?
  address               String?
  latitude              Float?
  longitude             Float?
  customFields          Json?
  status                AdStatus           @default(PENDING)
  rejectionReason       String?
  views                 Int                @default(0)
  contactClicks         Int                @default(0)
  whatsappSent          Boolean            @default(false)
  whatsappSentAt        DateTime?
  expiresAt             DateTime?
  publishedAt           DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime
  adNumber              Int                @unique @default(autoincrement())
  adType                String?
  neighborhood          String?
  rejectedReason        String?
  removedAt             DateTime?
  streetId              String?
  isWanted              Boolean            @default(false)
  requestedLocationText String?
  Category              Category           @relation(fields: [categoryId], references: [id])
  City                  City?              @relation(fields: [cityId], references: [id])
  Street                Street?            @relation(fields: [streetId], references: [id])
  User                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  AdImage               AdImage[]
  AdminAdLog            AdminAdLog[]
  Appointment           Appointment[]
  AvailabilitySlot      AvailabilitySlot[]
  EmailLog              EmailLog[]
  Favorite              Favorite[]
  NewspaperAd           NewspaperAd[]

  @@index([adNumber])
  @@index([categoryId])
  @@index([cityId])
  @@index([createdAt])
  @@index([status])
  @@index([streetId])
  @@index([userId])
}

model AdImage {
  id          String   @id
  adId        String
  url         String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  brandedUrl  String?
  originalUrl String?
  Ad          Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
}

model BannerAd {
  id          String   @id
  title       String
  description String?
  imageUrl    String
  link        String?
  position    String
  order       Int      @default(0)
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  clicks      Int      @default(0)
  impressions Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([isActive])
  @@index([position])
}

model Category {
  id             String          @id
  name           String
  nameHe         String
  slug           String          @unique
  description    String?
  icon           String?
  parentId       String?
  order          Int             @default(0)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  Ad             Ad[]
  Category       Category?       @relation("CategoryToCategory", fields: [parentId], references: [id])
  other_Category Category[]      @relation("CategoryToCategory")
  CategoryField  CategoryField[]

  @@index([parentId])
  @@index([slug])
}

model CategoryField {
  id         String   @id
  categoryId String
  name       String
  nameHe     String
  fieldType  String
  options    String?
  isRequired Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
}

model City {
  id           String         @id
  name         String         @unique
  nameHe       String
  slug         String         @unique
  region       String?
  latitude     Float?
  longitude    Float?
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  Ad           Ad[]
  Neighborhood Neighborhood[]
  Street       Street[]
  BrokerUsers  User[]         @relation("BrokerCity")

  @@index([name])
  @@index([slug])
}

model EmailAction {
  id        String   @id
  email     String
  action    String
  token     String   @unique
  data      Json?
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model Neighborhood {
  id        String   @id
  name      String
  cityId    String
  createdAt DateTime @default(now())
  updatedAt DateTime
  City      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  Street    Street[]

  @@unique([cityId, name])
  @@index([cityId])
  @@index([name])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Street {
  id             String        @id
  name           String
  code           String
  cityId         String
  neighborhoodId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  Ad             Ad[]
  City           City          @relation(fields: [cityId], references: [id], onDelete: Cascade)
  Neighborhood   Neighborhood? @relation(fields: [neighborhoodId], references: [id])

  @@unique([cityId, code])
  @@unique([cityId, name])
  @@index([cityId])
  @@index([name])
  @@index([neighborhoodId])
}

model User {
  id                         String                       @id @default(uuid())
  email                      String                       @unique
  password                   String?
  name                       String?
  phone                      String?
  role                       UserRole                     @default(USER)
  googleId                   String?                      @unique
  avatar                     String?
  isVerified                 Boolean                      @default(false)
  verificationToken          String?                      @unique
  resetToken                 String?
  resetTokenExpiry           DateTime?
  companyName                String?
  licenseNumber              String?
  description                String?
  website                    String?
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  isEmailVerified            Boolean                      @default(false)
  resetPasswordExpires       DateTime?
  resetPasswordToken         String?                      @unique
  verificationExpires        DateTime?
  brokerLogoApproved         Boolean                      @default(false)
  brokerCityId               String?
  brokerLicenseNumber        String?
  businessAddress            String?
  businessName               String?
  businessPhone              String?
  declarationAcceptedAt      DateTime?
  firstName                  String?
  lastName                   String?
  pendingEmail               String?
  phonePersonal              String?
  serviceProviderType        ServiceProviderType?
  termsAcceptedAt            DateTime?
  userType                   UserType?                    @default(USER)
  weeklyDigestOptIn          Boolean                      @default(true)
  aboutBusiness              String?
  aboutBusinessPending       String?
  aboutBusinessStatus        ApprovalStatus               @default(APPROVED)
  businessHours              Json?
  logoStatus                 ApprovalStatus               @default(APPROVED)
  logoUrlPending             String?
  officeAddress              String?
  officeAddressPending       String?
  officeAddressStatus        ApprovalStatus               @default(APPROVED)
  phoneBusinessOffice        String?
  publishOfficeAddress       Boolean                      @default(false)
  weeklyDigestSubscribed     Boolean                      @default(false)
  meetingsBlocked            Boolean                      @default(false)
  meetingsBlockReason        String?
  meetingsBlockedAt          DateTime?
  meetingsBlockedByAdminId   String?
  status                     UserStatus                   @default(ACTIVE)
  AccountDeletionRequest     AccountDeletionRequest[]
  Ad                         Ad[]
  AppointmentOwner           Appointment[]                @relation("AppointmentOwner")
  AppointmentRequester       Appointment[]                @relation("AppointmentRequester")
  BrandingConfig             BrandingConfig[]
  DataExportRequest          DataExportRequest[]
  EmailLog                   EmailLog[]
  Favorite                   Favorite[]
  HighlightRequest           HighlightRequest[]
  NewspaperAdCreated         NewspaperAd[]                @relation("NewspaperAdCreator")
  OfficeAddressChangeRequest OfficeAddressChangeRequest[]
  RefreshToken               RefreshToken[]
  BrokerCity                 City?                        @relation("BrokerCity", fields: [brokerCityId], references: [id])
  UserAppointmentPolicy      UserAppointmentPolicy?
  UserAudit                  UserAudit[]
  UserPreference             UserPreference?

  @@index([email])
  @@index([googleId])
  @@index([resetPasswordToken])
  @@index([verificationToken])
  @@index([brokerCityId])
  @@index([status])
}

model WhatsAppGroup {
  id         String   @id
  categoryId String   @unique
  name       String
  groupId    String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@index([categoryId])
}

model EmailLog {
  id             String      @id @default(uuid())
  userId         String?
  adId           String?
  type           EmailType
  status         EmailStatus
  recipientEmail String
  errorMessage   String?
  createdAt      DateTime    @default(now())
  Ad             Ad?         @relation(fields: [adId], references: [id])
  User           User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([adId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model AdminAdLog {
  id         String    @id @default(cuid())
  adminId    String
  adId       String
  action     String
  fromStatus AdStatus?
  toStatus   AdStatus?
  reason     String?
  createdAt  DateTime  @default(now())
  Ad         Ad        @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([adId])
  @@index([createdAt])
}

model BrandingConfig {
  id          String   @id @default(cuid())
  logoUrl     String   @default("")
  position    String   @default("bottom-left")
  opacity     Int      @default(70)
  sizePct     Int      @default(18)
  updatedById String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [updatedById], references: [id])

  @@index([updatedById])
}

model UserPreference {
  id               String   @id @default(cuid())
  userId           String   @unique
  weeklyDigest     Boolean  @default(false)
  notifyNewMatches Boolean  @default(false)
  filters          Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Appointment {
  id           String                  @id @default(cuid())
  adId         String
  requesterId  String
  ownerId      String
  date         DateTime
  proposedDate DateTime?               // תאריך מוצע חלופי
  note         String?
  status       AppointmentStatus       @default(PENDING)
  statusReason String?
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  ad           Ad                      @relation(fields: [adId], references: [id], onDelete: Cascade)
  owner        User                    @relation("AppointmentOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  requester    User                    @relation("AppointmentRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  history      AppointmentHistory[]

  @@index([requesterId])
  @@index([ownerId])
  @@index([adId])
  @@index([date])
  @@index([status])
}

model AppointmentHistory {
  id            String            @id @default(cuid())
  appointmentId String
  fromStatus    AppointmentStatus?
  toStatus      AppointmentStatus
  fromDate      DateTime?          // תאריך קודם
  toDate        DateTime?          // תאריך חדש
  reason        String?
  changedById   String?
  createdAt     DateTime          @default(now())
  appointment   Appointment       @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([createdAt])
}

model AvailabilitySlot {
  id        String   @id @default(cuid())
  adId      String
  dayOfWeek Int
  startTime String
  endTime   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
}

model UserAppointmentPolicy {
  id          String   @id @default(cuid())
  userId      String   @unique
  isBlocked   Boolean  @default(false)
  blockReason String?
  updatedById String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String
  targetId   String?
  entityType String?
  meta       Json?
  ip         String?
  createdAt  DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@index([targetId])
  @@index([entityType])
}

model UserAudit {
  id        String   @id @default(cuid())
  userId    String
  action    String
  meta      Json?
  createdAt DateTime @default(now())
  ip        String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  adId      String
  createdAt DateTime @default(now())
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, adId])
  @@index([userId])
  @@index([adId])
}

model PageView {
  id              String   @id @default(cuid())
  path            String
  userId          String?
  durationSeconds Int?
  sessionId       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  @@index([path])
  @@index([userId])
  @@index([createdAt])
}

model MailingListSubscriber {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  isActive       Boolean   @default(true)
  unsubscribedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([email])
  @@index([isActive])
}

model ContentDispatchLog {
  id             String   @id @default(cuid())
  fileName       String
  fileUrl        String?
  recipientEmail String
  sentAt         DateTime @default(now())
  status         String   @default("SENT")
  errorMessage   String?

  @@index([recipientEmail])
  @@index([sentAt])
  @@index([status])
}

model ImportLog {
  id          String   @id @default(cuid())
  adminId     String
  importType  String
  fileName    String
  totalRows   Int      @default(0)
  successRows Int      @default(0)
  failedRows  Int      @default(0)
  errors      Json?
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([importType])
  @@index([createdAt])
}

model BrokerOffice {
  id                      String             @id @default(cuid())
  brokerOwnerUserId       String             @unique
  businessName            String
  businessAddressApproved String
  businessAddressPending  String?
  businessPhone           String?
  website                 String?
  aboutBusinessApproved   String?
  aboutBusinessPending    String?
  publishOfficeAddress    Boolean            @default(false)
  logoUrlApproved         String?
  logoUrlPending          String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  BrokerTeamMember        BrokerTeamMember[]

  @@index([brokerOwnerUserId])
}

model BrokerTeamMember {
  id        String       @id @default(cuid())
  officeId  String
  fullName  String
  email     String
  phone     String
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  office    BrokerOffice @relation(fields: [officeId], references: [id], onDelete: Cascade)

  @@index([officeId])
  @@index([email])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  actionType  String
  entityType  String?
  entityId    String?
  metadata    Json?
  ip          String?
  createdAt   DateTime @default(now())

  @@index([actorUserId])
  @@index([actionType])
  @@index([entityType])
  @@index([createdAt])
}

model FeaturedRequest {
  id        String                @id @default(cuid())
  userId    String
  adId      String
  status    FeaturedRequestStatus @default(PENDING)
  notes     String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([userId])
  @@index([adId])
  @@index([status])
}

model DataExportRequest {
  id          String            @id @default(cuid())
  userId      String
  status      DataRequestStatus @default(PENDING)
  exportUrl   String?
  createdAt   DateTime          @default(now())
  processedAt DateTime?
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model AccountDeletionRequest {
  id          String            @id @default(cuid())
  userId      String
  status      DataRequestStatus @default(PENDING)
  reason      String?
  createdAt   DateTime          @default(now())
  processedAt DateTime?
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model OfficeAddressChangeRequest {
  id          String         @id @default(cuid())
  userId      String
  newAddress  String
  status      ApprovalStatus @default(PENDING)
  adminNotes  String?
  createdAt   DateTime       @default(now())
  processedAt DateTime?
  processedBy String?
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model HighlightRequest {
  id          String         @id @default(cuid())
  userId      String
  requestType String
  reason      String?
  status      ApprovalStatus @default(PENDING)
  adminNotes  String?
  createdAt   DateTime       @default(now())
  processedAt DateTime?
  processedBy String?
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model NewspaperAd {
  id        String   @id @default(cuid())
  adId      String
  filePath  String
  version   Int      @default(1)
  createdAt DateTime @default(now())
  createdBy String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  creator   User     @relation("NewspaperAdCreator", fields: [createdBy], references: [id])

  @@index([adId])
  @@index([createdBy])
  @@index([createdAt])
}

enum AdStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  DRAFT
  ACTIVE
  REMOVED
}

enum UserRole {
  USER
  BROKER
  ADMIN
  SUPER_ADMIN
  MODERATOR
  SERVICE_PROVIDER
}

enum UserStatus {
  ACTIVE
  PARTIAL_BLOCK
  BLOCKED
}

enum UserType {
  USER
  SERVICE_PROVIDER
}

enum ServiceProviderType {
  BROKER
  LAWYER
  APPRAISER
  DESIGNER_ARCHITECT
  MORTGAGE_ADVISOR
}

enum EmailType {
  AD_PUBLISHED_COPY
  AD_APPROVED
  AD_REJECTED
  VERIFICATION
  PASSWORD_RESET
}

enum EmailStatus {
  SUCCESS
  FAILED
}

enum AppointmentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELED
  COMPLETED
  RESCHEDULE_REQUESTED
}

enum FeaturedRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DataRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}
