# יישום כפתור צור קשר בעמוד המתווך

## תיאור
מימוש פונקציונליות לשליחת פניות למתווך דרך טופס יצירת קשר בעמוד הפרופיל הציבורי שלו.

## תאריך יישום
24 בפברואר 2026

## שינויים שבוצעו

### Backend

#### 1. מערכת האימייל
**קובץ:** `server/src/modules/email/email-types.enum.ts`
- נוסף EmailType חדש: `BROKER_CONTACT_REQUEST`
- נוספה מטאדטה למייל: "פניה חדשה ממשתמש - המקום"

**קובץ:** `server/src/modules/email/unified-email-template.service.ts`
- נוסף case חדש בפונקציה `getEmailTemplate()`
- נוספה תבנית מייל חדשה: `getBrokerContactRequestTemplate()`
- התבנית כוללת את פרטי המשתמש: שם, טלפון וכתובת מייל

#### 2. Validation
**קובץ:** `server/src/modules/broker/broker.validation.ts`
- נוסף schema חדש: `brokerContactRequestSchema`
- מאמת שם (מינימום 2 תווים), טלפון (מינימום 9 תווים) ומייל תקין
- נוסף type חדש: `BrokerContactRequestInput`

#### 3. Routes
**קובץ:** `server/src/modules/broker/broker.routes.ts`
- נוסף endpoint ציבורי חדש: `POST /api/broker/contact/:id`
- ה-endpoint לא דורש אימות (public)

#### 4. Controller
**קובץ:** `server/src/modules/broker/broker.controller.ts`
- נוספה מתודה חדשה: `sendContactRequest()`
- המתודה מנתחת את הנתונים וקוראת ל-service

#### 5. Service
**קובץ:** `server/src/modules/broker/broker.service.ts`
- נוספה מתודה חדשה: `sendContactRequest()`
- מחפשת את המתווך במערכת
- שולחת מייל למתווך עם פרטי המשתמש שעשה הפניה

### Frontend

**קובץ:** `client/src/pages/PublicBrokerPage.tsx`
- נוסף import של `toast` לצורך הודעות משוב
- נוסף state חדש: `isSubmitting` למעקב אחר מצב שליחה
- עודכנה פונקציה `handleContactSubmit()`:
  - שולחת בקשה POST ל-API
  - מציגה הודעת הצלחה/שגיאה למשתמש
  - מנקה את הטופס לאחר שליחה מוצלחת
- עודכן כפתור "צרו קשר":
  - מוצג טקסט "שולח..." בזמן שליחה
  - disabled בזמן שליחה
  - עיצוב disabled state

## זרימת העבודה

1. משתמש נכנס לעמוד הפרופיל הציבורי של מתווך
2. משתמש ממלא את פרטיו בטופס (שם, טלפון, מייל)
3. לוחץ על כפתור "צרו קשר"
4. הטופס נשלח ל-API: `POST /api/broker/contact/:id`
5. השרת מאמת את הנתונים
6. השרת מוצא את המתווך במערכת
7. נשלח מייל למתווך עם פרטי המשתמש
8. המשתמש מקבל הודעת הצלחה
9. הטופס מתנקה

## דוגמת מייל שנשלח למתווך

```
נושא: פניה חדשה ממשתמש - המקום

שלום,

קיבלת פניה חדשה דרך האתר:

┃ שם: [שם המשתמש]
┃ טלפון: [טלפון המשתמש]
┃ כתובת מייל: [מייל המשתמש]

מומלץ ליצור קשר עם המשתמש בהקדם האפשרי.
```

## בדיקות נדרשות

### Backend
- [ ] וודא ש-SendGrid מוגדר כראוי (.env)
- [ ] בדוק שליחת מייל לכתובת אמיתית
- [ ] וודא שהvalידציה עובדת נכון
- [ ] בדוק טיפול בשגיאות (מתווך לא קיים, שגיאת שליחה)

### Frontend
- [ ] בדוק שליחת טופס עם נתונים תקינים
- [ ] בדוק שהודעות toast מוצגות כראוי
- [ ] וודא שהכפתור נעשה disabled בזמן שליחה
- [ ] בדוק ניקוי הטופס לאחר שליחה מוצלחת
- [ ] בדוק טיפול בשגיאות רשת

## הערות
- הפונקציונליות לא דורשת אימות - כל משתמש יכול לשלוח פניה
- המיילים נשלחים דרך מערכת האימייל המרכזית (SendGrid)
- ניתן להרחיב בעתיד ולהוסיף rate limiting למניעת ספאם
- ניתן להוסיף שדה "הודעה" לטופס בעתיד

## סטטוס
✅ המימוש הושלם בהצלחה ללא שגיאות קומפילציה
