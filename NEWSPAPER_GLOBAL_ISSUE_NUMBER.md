# מערכת מספר גליון גלובלי - תיעוד יישום

## תאריך: 8 בפברואר 2026

## 📋 סיכום השינוי

הוספנו מערכת מרכזית לניהול מספר גליון משותף לכל הגליונות (רגילים וכללי).

### ❓ מה היה לפני?
- כל גיליון קיבל מספר גליון עצמאי בהתאם ל-`version` שלו
- גיליון כללי היה מקבל מספר שונה מהגיליונות הרגילים
- לא היה סנכרון בין הגליונות

### ✅ מה השתנה?
כעת **כל הגליונות** (רגילים וכללי) מציגים את **אותו מספר גליון**.

### 🔄 איך זה עובד?

1. **גיליון ראשון**: כל הגליונות מציגים "גליון 1"
2. **הפצת גליון כללי**: לאחר הפצה מוצלחת של הגליון הכללי, מספר הגליון הגלובלי עולה ל-2
3. **גיליון שני**: מכאן ואילך, כל הגליונות (כולל הכללי) יציגו "גליון 2"
4. **וכן הלאה**...

---

## 🛠️ שינויים טכניים

### 1. מודל חדש במסד הנתונים

**קובץ**: `server/prisma/schema.prisma`

```prisma
model NewspaperGlobalSettings {
  id              String   @id @default(cuid())
  currentIssue    Int      @default(1)
  lastDistributed DateTime?
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
}
```

### 2. Migration

**קובץ**: `server/prisma/migrations/20260208_add_newspaper_global_settings/migration.sql`

- יצירת טבלת `NewspaperGlobalSettings`
- הוספת שורה ראשונית עם `currentIssue = 1`

### 3. שינויים בקוד

#### 📄 `newspaper-sheet.service.ts`
- ✅ `getGlobalSettings()` - קבלת ההגדרות הגלובליות
- ✅ `incrementGlobalIssueNumber()` - העלאת מספר הגליון לאחר הפצה

#### 📄 `newspaper-sheet-pdf.service.ts`
- ✅ `getGlobalIssueNumber()` - שימוש במספר גליון גלובלי במקום `sheet.version`
- ✅ עדכון התבנית להציג "גליון X" בהתאם למספר הגלובלי

#### 📄 `newspaper-general-sheet.service.ts`
- ✅ `getGlobalIssueNumber()` - שימוש במספר גליון גלובלי
- ✅ עדכון התבנית להציג "גליון X" במקום "גיליון כללי - [תאריך]"

#### 📄 `newspaper-sheet.controller.ts`
- ✅ הוספת קריאה ל-`incrementGlobalIssueNumber()` לאחר הפצה מוצלחת של הגליון הכללי

---

## 📊 דוגמת תרחיש שימוש

### התחלה
```
כל הגליונות: "גליון 1"
גליון כללי: "גליון 1"
```

### לאחר הפצה ראשונה
```
✅ הגליון הכללי הופץ בהצלחה
→ מספר גליון גלובלי עלה ל-2
```

### ממשיכים
```
כל הגליונות: "גליון 2"
גליון כללי: "גליון 2"
```

### לאחר הפצה שנייה
```
✅ הגליון הכללי הופץ בהצלחה
→ מספר גליון גלובלי עלה ל-3

כל הגליונות: "גליון 3"
גליון כללי: "גליון 3"
```

---

## 🎯 נקודות חשובות

1. **מספר הגליון משותף לכולם** - כל הגליונות תמיד יציגו את אותו מספר
2. **העלאה רק לאחר הפצה** - המספר עולה רק כאשר הגליון הכללי מופץ בהצלחה
3. **שמירת היסטוריה** - כל גיליון עדיין שומר את ה-`version` שלו להיסטוריה
4. **תצוגה אחידה** - המספר המוצג ב-PDF זהה לכל הגליונות

---

## ✅ בדיקות שבוצעו

- [x] Migration עבר בהצלחה
- [x] Prisma Client נוצר מחדש
- [x] TypeScript compilation עבר ללא שגיאות
- [x] Build של Server עבר בהצלחה
- [x] Build של Client עבר בהצלחה

---

## 🚀 פקודות להרצה

```bash
# Server
cd server
npx prisma migrate deploy
npx prisma generate
npm run build

# Client
cd client
npm run build
```

---

**מיושם על ידי**: GitHub Copilot  
**תאריך**: 8 בפברואר 2026
